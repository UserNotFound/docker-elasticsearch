FROM quay.io/aptible/ubuntu:14.04

# Taken from dockerfile/java:oracle-java7
# Accept Oracle license agreement
RUN echo "oracle-java7-installer shared/accepted-oracle-license-v1-1 " \
         "select true" | debconf-set-selections

# Install Java 7 and clean up
RUN apt-install software-properties-common && \
    add-apt-repository -y ppa:webupd8team/java && \
    apt-install oracle-java7-installer

ENV ES_VERSION <%= ENV.fetch 'ES_VERSION' %>
ENV ES_BACKUP_PLUGIN_NAME <%= ENV.fetch 'ES_BACKUP_PLUGIN_NAME' %>
ENV ES_BACKUP_PLUGIN_VERSION <%= ENV.fetch 'ES_BACKUP_PLUGIN_VERSION' %>

# Install Elasticsearch and backup plugin.
RUN apt-install curl && \
    cd /tmp && \
    curl "https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-${ES_VERSION}.tar.gz" | tar xzf - && \
    mv "/tmp/elasticsearch-${ES_VERSION}" /elasticsearch && \
    /elasticsearch/bin/plugin install "elasticsearch/${ES_BACKUP_PLUGIN_NAME}/${ES_BACKUP_PLUGIN_VERSION}"

# Install NGiNX
RUN add-apt-repository -y ppa:nginx/stable && \
    apt-install nginx && mkdir -p /etc/nginx/ssl

# Install htpasswd for HTTP Basic Auth
RUN apt-install apache2-utils

# Install node.js and elasticdump tool for --dump/--restore options.
# https://github.com/taskrabbit/elasticsearch-dump
# # TODO - seems like this doesn't work with old node anymore
ENV NODE_VERSION 4.3.1
ENV ELASTICDUMP_VERSION 1.0.3
RUN curl "http://nodejs.org/dist/v$NODE_VERSION/node-v${NODE_VERSION}-linux-x64.tar.gz" | tar zxf - && \
    ln -s "/node-v${NODE_VERSION}-linux-x64/bin/node" /usr/local/bin/ && \
    ln -s "/node-v${NODE_VERSION}-linux-x64/bin/npm" /usr/local/bin/ && \
    npm install -g "elasticdump@${ELASTICDUMP_VERSION}" && \
    ln -s "/node-v${NODE_VERSION}-linux-x64/bin/elasticdump" /usr/local/bin/

ADD templates/nginx.conf.template /etc/nginx/nginx.conf.template
ADD templates/nginx-wrapper /usr/sbin/nginx-wrapper

# Mount elasticsearch.yml config template, remove default
ADD templates/elasticsearch.yml.template /elasticsearch/config/elasticsearch.yml.template
RUN rm /elasticsearch/config/elasticsearch.yml

ADD bin/run-database.sh /usr/bin/
ADD bin/utilities.sh /usr/bin/

ENV DATA_DIRECTORY /var/db
ENV SSL_DIRECTORY /etc/nginx/ssl

VOLUME ["$DATA_DIRECTORY"]
VOLUME ["$SSL_DIRECTORY"]

# Integration tests
ADD test /tmp/test
ADD <%= ENV.fetch 'TAG' %>/test /tmp/test
RUN bats /tmp/test

# Expose NGiNX proxy ports
EXPOSE 80
EXPOSE 443

ENTRYPOINT ["run-database.sh"]
